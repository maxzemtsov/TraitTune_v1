## TraitTune Sharing Backend API: Endpoint Outline

**Version:** 1.0
**Date:** May 11, 2025

### 1. Overview

This document outlines the proposed backend API endpoints for the TraitTune sharing functionality. These endpoints will be implemented using FastAPI and will interact with the PostgreSQL database managed by Supabase, based on the schema defined in `sharing_data_model.md`.

### 2. Authentication & Authorization

*   All endpoints (except potentially the link redirection/resolution endpoint) will require user authentication (JWT-based, via Supabase Auth).
*   Authorization checks will be implemented to ensure users can only manage their own sharing links and view relevant data.

### 3. API Endpoints

#### 3.1. Sharing Link Management

*   **POST `/api/v1/sharing/links/private/email`**
    *   **Description:** Creates a private sharing link to be sent via email.
    *   **Request Body:**
        ```json
        {
          "target_email": "invitee@example.com",
          "report_id": "uuid-of-report-to-share", // Optional
          "custom_message": "Check out my TraitTune report!" // Optional
        }
        ```
    *   **Response Body (Success 201 Created):**
        ```json
        {
          "link_id": "uuid-of-new-link",
          "sharer_user_id": "uuid-of-sharer",
          "link_type": "private_email",
          "unique_token": "secure-unique-token",
          "target_email": "invitee@example.com",
          "status": "generated", // Or "sent" if email is dispatched immediately
          "share_url": "https://traittune.com/invite/secure-unique-token",
          "created_at": "timestamp"
        }
        ```
    *   **Actions:** Generates a unique token, stores link details in `sharing_links`, potentially triggers an email sending service.

*   **POST `/api/v1/sharing/links/private/onetime`**
    *   **Description:** Creates a private one-time shareable link.
    *   **Request Body:**
        ```json
        {
          "report_id": "uuid-of-report-to-share", // Optional
          "expires_in_hours": 72 // Optional, for link expiry
        }
        ```
    *   **Response Body (Success 201 Created):**
        ```json
        {
          "link_id": "uuid-of-new-link",
          "sharer_user_id": "uuid-of-sharer",
          "link_type": "private_onetime",
          "unique_token": "secure-unique-token",
          "status": "generated",
          "share_url": "https://traittune.com/invite/secure-unique-token",
          "expires_at": "timestamp", // If applicable
          "created_at": "timestamp"
        }
        ```
    *   **Actions:** Generates a unique token, stores link details.

*   **POST `/api/v1/sharing/links/public`**
    *   **Description:** Creates a public sharing link for wider distribution.
    *   **Request Body:** (Potentially empty or with optional campaign tags)
        ```json
        {
          "campaign_tag": "spring_promo" // Optional
        }
        ```
    *   **Response Body (Success 201 Created):**
        ```json
        {
          "link_id": "uuid-of-new-link",
          "sharer_user_id": "uuid-of-sharer",
          "link_type": "public",
          "unique_token": "secure-public-token",
          "status": "active",
          "share_url": "https://traittune.com/share/secure-public-token",
          "created_at": "timestamp"
        }
        ```
    *   **Actions:** Generates a unique token, stores link details.

*   **POST `/api/v1/sharing/links/qr`**
    *   **Description:** Generates data/link for a QR code.
    *   **Request Body:** (Potentially empty)
    *   **Response Body (Success 201 Created):**
        ```json
        {
          "link_id": "uuid-of-new-link", // Or a reference to an existing link if QR is just another representation
          "sharer_user_id": "uuid-of-sharer",
          "link_type": "qr",
          "unique_token": "secure-qr-token",
          "qr_data_url": "https://traittune.com/qr/{secure-qr-token}", // Data to be encoded in QR
          "status": "active",
          "created_at": "timestamp"
        }
        ```
    *   **Actions:** Generates a unique token/identifier for QR, stores link details.

*   **GET `/api/v1/sharing/links`**
    *   **Description:** Retrieves a list of sharing links generated by the authenticated user.
    *   **Query Parameters:** `type` (e.g., private_email, public), `status`, `page`, `limit`.
    *   **Response Body (Success 200 OK):** Array of link objects (similar to POST responses).

*   **GET `/api/v1/sharing/links/{link_id}`**
    *   **Description:** Retrieves details of a specific sharing link.
    *   **Response Body (Success 200 OK):** Single link object.

*   **DELETE `/api/v1/sharing/links/{link_id}`**
    *   **Description:** Deactivates or deletes a sharing link (depending on policy).
    *   **Response Body (Success 204 No Content or 200 OK with status).

#### 3.2. Link Redirection & Event Tracking (Publicly Accessible with Token)

*   **GET `/invite/{unique_token}` or `/share/{unique_token}` or `/qr/{unique_token}`** (These are not API endpoints but frontend routes that will call an API endpoint for resolution)
    *   **Description:** This is the actual URL that users click. The frontend route will parse the token and call a backend API endpoint to resolve it.
    *   **Backend Resolution Endpoint (e.g., POST `/api/v1/sharing/resolve`):**
        *   **Request Body:** `{"token": "secure-unique-token"}`
        *   **Actions:**
            1.  Finds the link in `sharing_links` by `unique_token`.
            2.  If not found or expired, returns an error (e.g., 404 Not Found).
            3.  Logs a `clicked` event in `sharing_link_events` (with IP, User-Agent).
            4.  Updates `sharing_links.status` if applicable (e.g., to `clicked`).
            5.  Returns redirection information to the frontend (e.g., target page, context for new/existing user).
        *   **Response Body (Success 200 OK):**
            ```json
            {
              "link_type": "private_email",
              "sharer_info": { "name": "Sharer Name" }, // Optional, for personalization
              "action": "redirect_to_onboarding", // Or "redirect_to_assessment", "show_comparison_prompt"
              "target_url": "/onboarding?ref=token" // Or other relevant data for frontend routing
            }
            ```

*   **POST `/api/v1/sharing/events`**
    *   **Description:** Endpoint for the frontend to explicitly log significant events after a link is resolved (e.g., user registration, test start/completion if not automatically inferred).
    *   **Request Body:**
        ```json
        {
          "token": "secure-unique-token", // or link_id if resolved frontend-side
          "event_type": "registered_via_link", // "test_started_via_link", "test_completed_via_link"
          "recipient_user_id": "uuid-of-recipient" // If available
        }
        ```
    *   **Response Body (Success 201 Created):** Event confirmation.
    *   **Actions:** Creates a record in `sharing_link_events`. Updates `sharing_links.status`. Triggers bonus logic if `event_type` is `test_completed_via_link` for a public link.

#### 3.3. Bonus System

*   **GET `/api/v1/sharing/bonuses/balance`**
    *   **Description:** Retrieves the authenticated user's current token balance.
    *   **Response Body (Success 200 OK):**
        ```json
        {
          "user_id": "uuid-of-user",
          "token_balance": 150,
          "last_updated": "timestamp"
        }
        ```

*   **GET `/api/v1/sharing/bonuses/transactions`**
    *   **Description:** Retrieves a list of bonus transactions for the authenticated user.
    *   **Query Parameters:** `page`, `limit`.
    *   **Response Body (Success 200 OK):** Array of transaction objects.

#### 3.4. Group Comparison (Placeholder - Details TBD)

*   **POST `/api/v1/sharing/comparison/request`**
    *   **Description:** Initiates a request to compare profiles between two users (e.g., after a QR code interaction).
    *   **Request Body:**
        ```json
        {
          "initiator_user_id": "uuid-user-A",
          "target_user_id": "uuid-user-D",
          "context_id": "uuid-of-comparison-context-template"
        }
        ```
    *   **Response Body:** Details of the comparison or status of the request.

### 4. Email Service Integration

*   An email service (e.g., Supabase integrated email, SendGrid) will be needed to send `private_email` invitations.
*   The API creating email invites will trigger this service.

### 5. Next Steps

*   Begin implementation of these endpoints using FastAPI.
*   Set up database interaction logic (e.g., using Supabase client or an ORM).
*   Develop robust error handling and validation for all inputs.
